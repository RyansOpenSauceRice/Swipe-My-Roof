# LLM Prompting Guide for Roof Color Validation App

## Purpose
This document defines the standardized prompt structures and expected response formats for the Roof Color Validation App. It ensures the LLM consistently returns machine-readable, predictable output that the app can parse and act on.

---

## General Notes
- All LLM calls must request **JSON output only** (no extra commentary).
- Include a **system message** or equivalent instructing the model to:
  - Return JSON strictly matching the specified schema.
  - Use only allowed values for constrained fields.
  - Keep explanations short (≤3 words).
  - Use lowercase for `color` values unless proper noun required.
- Confidence should be a float between 0.0 and 1.0, with 2 decimal places.
- If unsure, still pick the most probable value but lower confidence accordingly.

---

## Standard Palette
The app restricts LLM output to the following color values:
```
black
dark gray
light gray
red
brown
tan
green
blue
white
other
```

---

## Request Formats

### 1. Standard Roof Color Inference
Used in **real mode** and **practice mode** for normal (non-decoy) suggestions.

**System Instruction:**
```
You are a tool for tagging roof colors on OpenStreetMap buildings.
Given metadata and an image summary, return a JSON object describing the most likely roof color, confidence, and a brief explanation.
Do not include text outside the JSON.
Use only the approved color palette provided.
```

**User Payload Example:**
```json
{
  "building_id": 123456,
  "location": { "lat": 46.12345, "lon": -98.54321 },
  "bbox": { "minx": -98.544, "miny": 46.122, "maxx": -98.542, "maxy": 46.124 },
  "existing_roof_colour": null,
  "building_ratio": 1.3,
  "image_summary": {
    "thumbnail_base64": "<base64 of 64x64 image>",
    "dominant_colors": ["dark gray", "light gray"],
    "quality": "full"  // or "partial"
  },
  "allowed_colors": [
    "black", "dark gray", "light gray", "red",
    "brown", "tan", "green", "blue", "white", "other"
  ]
}
```

**Expected Response:**
```json
{
  "color": "dark gray",
  "confidence": 0.78,
  "explanation": "uniform tone"
}
```

### 2. High-Resolution Variant
Used when the user allows higher token use or needs better accuracy.

**Differences:**
- `thumbnail_base64` may be up to 128×128 resolution.
- `dominant_colors` may include up to 5 values.
- Additional `full_image_base64` field (optional).

**Example High-Resolution Payload:**
```json
{
  "building_id": 123456,
  "location": { "lat": 46.12345, "lon": -98.54321 },
  "bbox": { "minx": -98.544, "miny": 46.122, "maxx": -98.542, "maxy": 46.124 },
  "existing_roof_colour": null,
  "building_ratio": 1.3,
  "image_summary": {
    "thumbnail_base64": "<base64 of 128x128 image>",
    "full_image_base64": "<optional base64 of higher-res image>",
    "dominant_colors": ["dark gray", "light gray", "black", "brown", "tan"],
    "quality": "full"
  },
  "allowed_colors": [
    "black", "dark gray", "light gray", "red",
    "brown", "tan", "green", "blue", "white", "other"
  ]
}
```

### 3. AI Re-Suggestion
When the user rejects a color and requests an AI re-check.

**System Instruction:**
```
Re-analyze the building's roof color using the provided image and metadata.
Take into account that the previous color suggestion was rejected.
Suggest the next most probable color from the palette.
Return JSON only.
```

**User Payload Example:**
```json
{
  "building_id": 123456,
  "previous_color": "dark gray",
  "location": { "lat": 46.12345, "lon": -98.54321 },
  "image_summary": {
    "thumbnail_base64": "<base64 of 64x64 image>",
    "dominant_colors": ["brown", "tan"],
    "quality": "partial"
  },
  "allowed_colors": ["black","dark gray","light gray","red","brown","tan","green","blue","white","other"]
}
```

**Expected Response:**
```json
{
  "color": "brown",
  "confidence": 0.65,
  "explanation": "mixed tones"
}
```

### 4. Low-Confidence Handling
When image quality is poor or colors are ambiguous:
- LLM still returns a color but sets confidence ≤ 0.4.
- Explanation should reflect the uncertainty, e.g., "low quality" or "shadowed".

**Example Response:**
```json
{
  "color": "other",
  "confidence": 0.35,
  "explanation": "low quality"
}
```

---

## Decoy Integration
- Decoys are never generated by the LLM — they are inserted by the app logic.
- The app must not send decoy prompts to the LLM; decoy data bypasses inference.
- Decoys should be sufficiently different from the actual roof color to be easily identifiable.

---

## Error Handling & Retries
- If the LLM response is invalid JSON:
  - Retry once with a system instruction emphasizing valid JSON only.
  - If still invalid, fall back to heuristic-only suggestion and mark as "method": "fallback".
- If the LLM fails entirely, return:
```json
{
  "color": "other",
  "confidence": 0.0,
  "explanation": "no ai result"
}
```

---

## Prompt Optimization
- Keep prompts as compact as possible to minimize token usage.
- Consider using a two-stage approach for high-confidence cases:
  1. First, send minimal metadata without image to check if the LLM can make a determination.
  2. Only send image data if the LLM requests it or returns low confidence.
- For batch processing, consider sending multiple buildings in a single request if the LLM supports it.

---

## Future Extensions
- Add optional "secondary_color" field for multi-tone roofs.
- Include "method" field in all responses for audit ("llm", "local_model", "fallback").
- Support additional palettes for region-specific colors.
- Implement a feedback loop where user corrections improve the LLM's suggestions over time.