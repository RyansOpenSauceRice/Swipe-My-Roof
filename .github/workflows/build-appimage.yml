name: Build AppImage

on:
  push:
    branches: [ main, feature/* ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  build-appimage:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgtk-3-0 \
          libx11-6 \
          libfontconfig1 \
          libfreetype6 \
          wget \
          file \
          fuse
          
    - name: Download AppImageTool
      run: |
        wget -O appimagetool https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
        chmod +x appimagetool
        
    - name: Restore and build
      run: |
        dotnet restore src/SwipeMyRoof.AvaloniaUI/SwipeMyRoof.AvaloniaUI.csproj
        dotnet publish src/SwipeMyRoof.AvaloniaUI/SwipeMyRoof.AvaloniaUI.csproj \
          --configuration Release \
          --runtime linux-x64 \
          --self-contained true \
          --output ./publish/linux-x64 \
          -p:PublishSingleFile=false \
          -p:PublishTrimmed=true \
          -p:TrimMode=partial
          
    - name: Create AppDir structure
      run: |
        mkdir -p SwipeMyRoof.AppDir/usr/bin
        mkdir -p SwipeMyRoof.AppDir/usr/share/applications
        mkdir -p SwipeMyRoof.AppDir/usr/share/icons/hicolor/256x256/apps
        
        # Copy application files
        cp -r ./publish/linux-x64/* SwipeMyRoof.AppDir/usr/bin/
        
        # Create desktop file
        cat > SwipeMyRoof.AppDir/usr/share/applications/SwipeMyRoof.desktop << 'EOF'
        [Desktop Entry]
        Type=Application
        Name=Swipe My Roof
        Comment=Validate roof colors for OpenStreetMap
        Exec=SwipeMyRoof.AvaloniaUI
        Icon=SwipeMyRoof
        Categories=Graphics;Photography;Science;
        Terminal=false
        StartupWMClass=SwipeMyRoof.AvaloniaUI
        EOF
        
        # Create a simple icon (you can replace this with a real icon later)
        cat > SwipeMyRoof.AppDir/usr/share/icons/hicolor/256x256/apps/SwipeMyRoof.svg << 'EOF'
        <svg width="256" height="256" xmlns="http://www.w3.org/2000/svg">
          <rect width="256" height="256" fill="#4CAF50"/>
          <rect x="64" y="64" width="128" height="96" fill="#2E7D32"/>
          <polygon points="64,64 128,32 192,64" fill="#FF5722"/>
          <text x="128" y="200" text-anchor="middle" fill="white" font-size="24" font-family="Arial">SMR</text>
        </svg>
        EOF
        
        # Create AppRun script
        cat > SwipeMyRoof.AppDir/AppRun << 'EOF'
        #!/bin/bash
        SELF=$(readlink -f "$0")
        HERE=${SELF%/*}
        export PATH="${HERE}/usr/bin/:${PATH}"
        export LD_LIBRARY_PATH="${HERE}/usr/lib/:${LD_LIBRARY_PATH}"
        cd "${HERE}/usr/bin"
        exec ./SwipeMyRoof.AvaloniaUI "$@"
        EOF
        chmod +x SwipeMyRoof.AppDir/AppRun
        
        # Copy desktop file to root
        cp SwipeMyRoof.AppDir/usr/share/applications/SwipeMyRoof.desktop SwipeMyRoof.AppDir/
        
        # Copy icon to root
        cp SwipeMyRoof.AppDir/usr/share/icons/hicolor/256x256/apps/SwipeMyRoof.svg SwipeMyRoof.AppDir/SwipeMyRoof.svg
        
    - name: Build AppImage
      run: |
        ./appimagetool SwipeMyRoof.AppDir SwipeMyRoof-x86_64.AppImage
        chmod +x SwipeMyRoof-x86_64.AppImage
        
    - name: Test AppImage
      run: |
        # Basic test - just check if it's a valid AppImage
        file SwipeMyRoof-x86_64.AppImage
        ls -la SwipeMyRoof-x86_64.AppImage
        
    - name: Create build info
      run: |
        # Determine build type based on branch
        if [ "${{ github.ref_name }}" = "main" ]; then
          BUILD_TYPE="DEVELOPMENT"
          BUILD_DESC="Latest development build from main branch"
        else
          BUILD_TYPE="FEATURE-TEST"
          BUILD_DESC="Feature test build from ${{ github.ref_name }} branch"
        fi
        
        cat > BUILD_INFO.md << EOF
        # Swipe My Roof - Linux AppImage ($BUILD_TYPE)
        
        ## 🚀 One-Click Download & Run
        
        **Super Easy Testing:**
        1. Download \`SwipeMyRoof-x86_64.AppImage\`
        2. Make executable: \`chmod +x SwipeMyRoof-x86_64.AppImage\`
        3. Double-click or run: \`./SwipeMyRoof-x86_64.AppImage\`
        
        **⚠️ This is a $BUILD_TYPE build - expect bugs and missing features!**
        
        ## 🧪 What's Currently Working
        
        - ✅ **Basic UI**: Avalonia desktop interface
        - ✅ **Settings Tab**: Configuration interface
        - ✅ **Bing Maps Integration**: Satellite imagery (needs API key)
        - ✅ **Building Validation View**: Core UI structure
        - ⚠️ **OSM Submission**: Implemented but needs testing
        - ⚠️ **AI Analysis**: Needs API key configuration
        - ❌ **Location Search**: Not yet implemented
        - ❌ **Swipe Gestures**: Partially implemented
        
        ## 🔧 Testing Setup
        
        1. **Get Bing Maps API Key** (Required for satellite imagery):
           - Go to [Bing Maps Dev Center](https://www.bingmapsportal.com/)
           - Create free account and get API key
           - Enter in Settings tab
           
        2. **Optional AI Provider**:
           - OpenAI API key for GPT analysis
           - Anthropic API key for Claude analysis
           
        3. **Test What Works**:
           - Settings configuration
           - Basic UI navigation
           - Satellite imagery (with API key)
        
        ## 📊 Build Info
        
        - **Type**: $BUILD_TYPE
        - **Branch**: ${{ github.ref_name }}
        - **Commit**: ${{ github.sha }}
        - **Built**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        - **Description**: $BUILD_DESC
        
        ## 🐛 Expected Issues & Testing
        
        **Known Limitations:**
        - Location search not implemented
        - Swipe gestures incomplete
        - Error handling needs improvement
        - UI polish needed
        
        **Please Test & Report:**
        - App startup and basic navigation
        - Settings tab functionality
        - Satellite imagery loading (with API key)
        - Any crashes or errors
        
        **Report Issues**: [GitHub Issues](https://github.com/RyansOpenSauceRice/Swipe-My-Roof/issues)
        
        Thanks for testing! 🚀
        EOF
        
    - name: Upload AppImage artifact
      uses: actions/upload-artifact@v4
      with:
        name: SwipeMyRoof-AppImage-${{ github.ref_name }}
        path: |
          SwipeMyRoof-x86_64.AppImage
          BUILD_INFO.md
        retention-days: 30
        
    - name: Create GitHub Release (Development Builds)
      if: github.event_name == 'push'
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: dev-build-${{ github.run_number }}-${{ github.ref_name }}
        release_name: Development Build ${{ github.run_number }} (${{ github.ref_name }})
        body_path: BUILD_INFO.md
        draft: false
        prerelease: true  # Mark as pre-release since these are development builds
        
    - name: Upload AppImage to Release
      if: steps.create_release.outcome == 'success'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./SwipeMyRoof-x86_64.AppImage
        asset_name: SwipeMyRoof-x86_64.AppImage
        asset_content_type: application/octet-stream
        
    - name: Comment on PR with AppImage download
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const { number } = context.issue;
          
          const comment = `🚀 **AppImage Test Build Ready!**
          
          A Linux AppImage has been created for this PR. You can download it from the [Actions tab](https://github.com/${owner}/${repo}/actions/runs/${{ github.run_id }}).
          
          **One-Click Testing:**
          1. Download \`SwipeMyRoof-x86_64.AppImage\` from artifacts
          2. Make executable: \`chmod +x SwipeMyRoof-x86_64.AppImage\`
          3. Run: \`./SwipeMyRoof-x86_64.AppImage\`
          
          **What to Test:**
          - App startup and basic navigation
          - Settings tab functionality  
          - Satellite imagery (needs Bing Maps API key)
          - Any crashes or UI issues
          
          **Build Info:**
          - Branch: \`${{ github.ref_name }}\`
          - Commit: \`${{ github.sha }}\`
          - Type: Feature test build
          
          ⚠️ This is a development build - expect bugs and missing features!`;
          
          github.rest.issues.createComment({
            owner,
            repo,
            issue_number: number,
            body: comment
          });